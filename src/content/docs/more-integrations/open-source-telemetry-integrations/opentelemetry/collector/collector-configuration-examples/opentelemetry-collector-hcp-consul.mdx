---
title: Collector for monitoring HCP Consul metrics
tags:
  - Integrations
  - Open source telemetry integrations
  - OpenTelemetry
  - Consul
  - HCP
  - Hashicorp
  - Networking
  - Server
  - Envoy
metaDescription: You can collect metrics from HCP managed Consul using the OpenTelemetry Collector.
freshnessValidatedDate: never
---

You can collect metrics about your HCP-managed Consul deployment with the OpenTelemetry Collector. The collector is a component of OpenTelemetry that collects, processes, and exports telemetry data to New Relic (or any observability backend).

This example works by running a prometheus receiver configuration inside the OpenTelemetry collector, which scrapes [HCP Consul's service metrics API](https://developer.hashicorp.com/hcp/docs/consul/monitor/metrics) and exports that data to [New Relic's OpenTelemetry API endpoint](https://docs.newrelic.com/docs/more-integrations/open-source-telemetry-integrations/opentelemetry/get-started/opentelemetry-set-up-your-app/#note-endpoints).

HCP Consul emits two forms of observability metrics, [Service metrics](https://developer.hashicorp.com/hcp/docs/consul/monitor/consul-central/observability#server-metrics) and [Envoy proxy metrics](https://developer.hashicorp.com/hcp/docs/consul/monitor/consul-central/observability#envoy-proxy-metrics). The example collector used in this guide will get you started with HCP Consul server metrics. For Envoy metrics, you can reference the notes below on Envoy metrics or check the [HCP Documentation](https://developer.hashicorp.com/hcp/docs/consul/monitor/consul-central/observability/telemetry-collector#forward-metrics-to-another-collector).

Complete the steps below to collect metrics from HCP consul and export them to New Relic.

<Steps>
    <Step>
        ## Make sure you're set up

      Before you start, you need to have the <InlinePopover type="licenseKey" /> for the account you want to report data to. You should also verify that:

      * You have a docker daemon running
      * You have [Docker Compose](https://docs.docker.com/compose/) installed
      * You have your [HCP Consul ACL admin token](https://developer.hashicorp.com/hcp/docs/consul/hcp-managed/access#generate-admin-token) available 

    </Step>

    <Step>
        ## Download or clone the example repos

        Download [New Relic's OpenTelemetry Examples repo](https://github.com/newrelic/newrelic-opentelemetry-examples) as this setup uses its example collector configuration. Once installed, open the [HCP Consul example](https://github.com/newrelic/newrelic-opentelemetry-examples/tree/main/other-examples/collector/hcp-consul) directory. For more information, you can check the `README` there as well.

    </Step>

    <Step>
      ##  Set environment variables and run the collector
        * Set the HCP Access Token and Access URL values in the `.env` file
        * Set the New Relic API key variable to your New Relic license ingest key in the `.env` file

```bash
  # Open the HCP Consul example directory
  cd newrelic-opentelemetry-examples/other-examples/collector/hcp-consul

  # Set environment variables.

  # run the collector in docker
  docker compose up
```

      ### Local Variable information

        <table>
          <thead>
            <tr>
              <th style={{ width: "200px"}}>
                Variable
              </th>
              <th>
                Description
              </th>
              <th>
                Docs
              </th>
            </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  `NEW_RELIC_API_KEY`
                </td>
                <td>
                  New Relic Ingest API Key
                </td>
                <td>
                  [API Key docs](/docs/apis/intro-apis/new-relic-api-keys/)
                </td>
              </tr>
              <tr>
                <td>
                  `NEW_RELIC_OTLP_ENDPOINT`
                </td>
                <td>
                  Default US New Relic OTLP endpoint is https://otlp.nr-data.net:4318
                </td>
                <td>
                  [OTLP endpoint config docs](/docs/more-integrations/open-source-telemetry-integrations/opentelemetry/get-started/opentelemetry-set-up-your-app/#review-settings)
                </td>
              </tr>
              <tr>
                <td>
                  `HCP_ACCESS_TOKEN`
                </td>
                <td>
                  ACL Admin token for HCP Consul
                </td>
                <td>
                  [Docs for creating an ACL admin token](https://developer.hashicorp.com/hcp/docs/consul/hcp-managed/access#generate-admin-token)
                </td>
              </tr>
              <tr>
                <td>
                  `HCP_ACCESS_URL`
                </td>
                <td>
                  URL to access your specific Consul server
                </td>
                <td>
                  [docs to locate your access URL](https://developer.hashicorp.com/hcp/docs/consul/hcp-managed/access#get-access-url)
                </td>
              </tr>
            </tbody>
        </table>

    </Step>
    <Step>
      ## HCP Consul Envoy Metrics
        To monitor HCP Consul Envoy metrics in New Relic, you can configure the OpenTelemetry collector built into your HCP Consul cluster to forward metrics to your own collector. This can include the collector running in this example.


        First you will need to add an http reciever to the OpenTelemetry collector. you can add this into the `receivers` group in the example `collector.yaml` file.

          ```yaml
            receivers:
              otlp:
                protocols:
                  http:
          ```
        This will add a receiver listening at `0.0.0.0:4318`. Once that is set up, you can then configure your HCP Consul cluster to forward envoy metrics to this receiver. This can be configured from the `telemetryCollector` stanza in your HCP Consul configuration file. Here is an example configuration you can use:

          ```yaml
              telemetryCollector:
                enabled: true
                customExporterConfig: |-
                  {
                    "exporter_config": {
                      "otlphttp": {
                        "endpoint": "0.0.0.0:4318",
                        "headers": {
                          "authorization": "<auth>"
                        },
                        "timeout": "2s"
                      }
                    }
                  }

          ```

    </Step>
    <Step>

       ## View your data in New Relic

      You can view your HCP Consul server data in a few different ways.

      * Navigate to the [New Relic marketplace](https://one.newrelic.com/marketplace) and search for `consul`. The available dashboards can be installed right onto your account!
      * Navigate to the metrics explorer and filter for `consul`, or `envoy` for envoy metrics. This data can be added to any custom alert or dashboard.      

    <Callout variant="tip">
      To view all metrics available with this HCP Consul server integration, reference the [documentation here](https://developer.hashicorp.com/consul/docs/agent/telemetry#metrics-reference).
    </Callout>

    </Step>
</Steps>