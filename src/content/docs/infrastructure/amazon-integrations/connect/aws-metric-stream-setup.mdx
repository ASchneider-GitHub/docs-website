---
title: Set up the Amazon CloudWatch Metric Streams integration
tags:
  - Integrations
  - Amazon integrations
  - AWS integrations list
metaDescription: Learn how to gather all AWS metrics and custom namespaces to send them to New Relic.
redirects:
    - /docs/infrastructure/amazon-integrations/connect/aws-metric-stream-setup
    - /docs/infrastructure/amazon-integrations/connect/cloudwatch-metric-streams/aws-metric-stream-setup
freshnessValidatedDate: never
---

With the AWS Metric Streams integration, you only need a <DNT>**single service**</DNT>, [AWS CloudWatch](https://aws.amazon.com/cloudwatch/), to gather all AWS metrics and custom namespaces and send them to New Relic.

To stream CloudWatch metrics to New Relic:

1. Check the [minimal permissions and mapping instructions](#permissions).
2. Create Kinesis Data Firehose and point it to New Relic.
3. Next, create a CloudWatch Metric Stream to send metrics to that Firehose you've just created.
4. Follow the [guided](#setup-cloudformation) or [manual](#manual-setup) setup instructions.
5. Validate [data reception](#validate-data).

If applicable, read our documentation about [migrating from AWS polling integrations](/docs/infrastructure/amazon-integrations/connect/aws-metric-stream#migrating-from-poll-integrations).

<Callout variant="tip">
  You can use Terraform to automate the process of enabling cloud integrations. Read how in the [Terraform official documentation site](https://registry.terraform.io/providers/newrelic/newrelic/latest/docs/guides/cloud_integrations_guide).
</Callout>

## Minimal permissions and mapping instructions [#permissions]

To enrich CloudWatch metrics with additional service metadata and custom tags, any AWS role configured in New Relic must be granted the following minimal permissions:

```
config:BatchGetResourceConfig
config:ListDiscoveredResources
elasticache:DescribeCacheClusters
tag:GetResources
```

The New Relic UI currently recommends the `ReadOnlyAccess` policy over these individual items so that New Relic has proper permissions to collect service data that's not available in AWS CloudWatch Metric Streams.

## New Relic and AWS accounts and regions mapping [#map-accounts-regions]

* If you manage multiple AWS accounts, then each account needs to be connected to New Relic.
* If you manage multiple regions within those accounts, then each region needs to be configured with a different Kinesis Data Firehose pointing to New Relic.
* You will typically map one or many AWS accounts to a single New Relic account.

## Guided setup using CloudFormation [#setup-cloudformation]

First, you need to link each of your AWS accounts with your New Relic account. To do so, use either of these options:

* Go to <DNT>**[one.newrelic.com > All capabilities](https://one.newrelic.com/all-capabilities) > Infrastructure > AWS**</DNT>, click on <DNT>**Add an AWS account**</DNT>, then on <DNT>**Use metric streams**</DNT>, and follow the steps.
* [Automate this step with NerdGraph](/docs/apis/nerdgraph/examples/nerdgraph-cloud-integrations-api-tutorial/#link-aws-cloudwatch).

Next, set up the metric stream using the [CloudFormation template](https://console.aws.amazon.com/cloudformation/home?#/stacks/quickcreate?templateURL=https://nr-downloads-main.s3.amazonaws.com/cloud_integrations/aws/cloudformation/MetricStreams_CloudFormation.yml&stackName=NewRelic-Metric-Stream&param_NewRelicDatacenter=US) we provide in the last step of our UI. This template is provided as a base to set up the integration on a single region. You can customize and extend it to meet your requirements.

### CloudFormation Template Parameters

This table outlines the various parameters required for the CloudFormation template. Since the template will create new resources in your AWS account, we don't providing names of existing AWS resources here.

<table>
  <thead>
    <tr>
      <th style={{ width: '200px' }}>
        Name
      </th>

      <th>
        Description
      </th>

      <th>
        Constraints
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        New Relic Ingest License Key
      </td>

      <td>
        The <InlinePopover type="licenseKey"/> associated with the account you wish to export metrics to.
      </td>

      <td>
        40-character hexadecimal string
      </td>
    </tr>

    <tr>
      <td>
        New Relic Datacenter
      </td>

      <td>
        Identification of the New Relic data center your metrics are exported to. (EU data center accounts have license keys prefixed with `eu0x`)
      </td>

      <td>
        Allowed values: `US`, `EU`
      </td>
    </tr>

    <tr>
      <td>
        CloudWatch Metric Stream name
      </td>

      <td>
        Name of new CloudWatch Metric Stream (must be unique per AWS account in the same AWS Region)
      </td>

      <td>
        Must only container letters (uppercase and lowercase), numbers, and characters '\_', and '-' with max length of 255 total characters
      </td>
    </tr>

    <tr>
      <td>
        Kinesis Data Firehose name
      </td>

      <td>
        Name of new Kinesis Firehose Delivery Stream (must be unique per AWS account in the same AWS Region)
      </td>

      <td>
        Must only container letters (uppercase and lowercase), numbers, and characters '.', '\_', and '-' with max length of 64 total characters
      </td>
    </tr>

    <tr>
      <td>
        Firehose S3 backup bucket name
      </td>

      <td>
        Name of new S3 Bucket Destination for failed events (must be globally unique across all AWS accounts in all AWS Regions within a partition)
      </td>

      <td>
        Must adhere to the [S3 bucket naming rules](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html)
      </td>
    </tr>

    <tr>
      <td>
        Enrich metrics with resource metadata from AWS Config
      </td>

      <td>
        Enable and configure AWS Config to track resource changes. This allows you a complete monitoring New Relic experience.
      </td>

      <td>
        Allowed values: `true`, `false`
      </td>
    </tr>

    <tr>
      <td>
        Config S3 backup bucket name
      </td>

      <td>
        Name of new S3 Bucket Destination for delivery channel configuration (must be globally unique across all AWS accounts in all AWS Regions within a partition)
      </td>

      <td>
        Must adhere to the [S3 bucket naming rules](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html)
      </td>
    </tr>
  </tbody>
</table>

<Callout variant="tip">
  The provided CloudFormation template doesn't include any inclusion nor exclusion namespace filter in CloudWatch metric streams. Consider adapting the base template based on your business requirements.
</Callout>

## Manual setup using AWS Console, API, or calls [#manual-setup]

1. **Create a Kinesis Data Firehose Delivery Stream** and configure the following destination parameters:

   * Source: Direct PUT or other sources
   * Data transformation: Disabled
   * Record format conversion: Disabled
   * Destination: New Relic
   * Ensure the following settings are defined:
     * New Relic configuration (Destination Settings)
       * HTTP endpoint URL - US Datacenter: `https://aws-api.newrelic.com/cloudwatch-metrics/v1`
       * HTTP endpoint URL - EU Datacenter: `https://aws-api.eu01.nr-data.net/cloudwatch-metrics/v1`
       * API key: Enter your <InlinePopover type="licenseKey"/>
       * Content encoding: `GZIP`
       * Retry duration: `60`
     * S3 backup mode: Failed data only
     * S3 bucket: select a bucket or create a new one to store metrics that failed to be sent.
     * New Relic buffer conditions
       * Buffer size: `1 MB`
       * Buffer interval: `60 (seconds)`
     * Permissions IAM role:
       * Create or update IAM role

2. **Create the metric stream**.

   * Go to <DNT>**CloudWatch service**</DNT> in your AWS console and select the <DNT>**Streams**</DNT> option under the <DNT>**Metrics**</DNT> menu.
   * Click <DNT>**Create metric stream**</DNT>.
   * Determine the right configuration based on your use cases:
     * Use inclusion and exclusion filters to select which services should push metrics to New Relic.
     * Select your Kinesis Data Firehose.
     * Define a meaningful name for the stream (for example, `newrelic-metric-stream)`.
   * Change default output format to `Open Telemetry 0.7`. (JSON is not supported.)
   * Confirm the creation of the metric stream.

     Alternatively, you can find instructions on the AWS documentation to create the CloudWatch metric stream using a CloudFormation template, API, or the CLI.

3. **Add the new AWS account** in the <DNT>**Metric streams**</DNT> mode in the New Relic UI.
   Go to <DNT>**[one.newrelic.com > All capabilities](https://one.newrelic.com/all-capabilities) > Infrastructure > AWS**</DNT>, click on <DNT>**Add an AWS account**</DNT>, then on <DNT>**Use metric streams**</DNT>, and follow the steps.

## Validate your data is received correctly [#validate-data]

To confirm you're receiving data from the Metric Streams, follow these steps:

1. Go to <DNT>**[one.newrelic.com > All capabilities](https://one.newrelic.com/all-capabilities) > Infrastructure > AWS**</DNT>, and search for the <DNT>**Stream**</DNT> accounts.
2. Check the following:

   * Account status dashboard. Useful to confirm that New Relic receives the metric data (errors, number of namespaces/metrics ingested, etc.)
   * Explore your data. Use metrics and events to find a specific set of metrics, access all dimensions available for a given metric, and more.

It may take few minutes until new resources are detected and synthesized as entities. See [cloud integrationssystem limits](/docs/data-apis/manage-data/view-system-limits) for more information.

<Callout variant="tip">
  AWS CloudWatch metrics for global services, such AWS Billing, are only availble in the <DNT>**us-east-1**</DNT> region. Make sure there's an active CloudWatch metric stream configured in that region.
</Callout>

## Migrate to Metric Streams [#migrate]

We recommend that existing customers migrate from API polling to Metric Streams using a CloudFormation template by following the instructions below.

<CollapserGroup>
    <Collapser
        id="with-template"
        title="Migrate with CloudFormation template (Recommended)"
    >
        1. Replicate the namespaces from polling into metric streams by going to <DNT>**[one.newrelic.com > All capabilities](https://one.newrelic.com/all-capabilities) > Infrastructure > AWS > Migrate to AWS Cloudwatch metric streams**</DNT>, and then configuring your AWS Metric Streams account.
        2. Download the customized CloudFormation template under the **Configure metric streams** step. This template contains the preconfigured namespaces that are based on your existing polling configuration.
        3. Add your account details to the downloaded template.
        4. In the AWS Console, upload your CloudFormation template by going to **Cloud Formation > Create Stack > Upload a template file**.

    </Collapser>
    <Collapser
        id="without-template"
        title="Migrate without CloudFormation template"
    >
        1. Go to <DNT>**[one.newrelic.com > All capabilities](https://one.newrelic.com/all-capabilities) > Infrastructure > AWS > Add an AWS account**</DNT>, then add your AWS account. This step is required even if you've already linked your AWS account with polling integrations.
        2. Enable AWS CloudWatch Metric Stream and the AWS Kinesis Data Firehose in the final step of the **Add an AWS account** process. This pushes metrics to New Relic. AWS CloudWatch requires one stream per region, so repeat this step for any additional AWS regions you want to monitor.
        3. Ensure metrics are received from all connected regions and namespaces. This may take several minutes.
        4. Disable all unnecessary polling integrations in the previous AWS provider account. Remember that [some integrations still need to be enabled](/docs/infrastructure/amazon-integrations/connect/aws-metric-stream#integrations-not-replaced-streams) because they aren't fully replaced by Metric Streams.
    </Collapser>
</CollapserGroup>

### Query, dashboard, and alert considerations [#considerations]

Our AWS Metric Streams integration uses the Metric API to push metrics in the [dimensional metric](/docs/data-apis/understand-data/new-relic-data-types/#dimensional-metrics) format.

Our poll-based AWS integration pushes metrics based on [events](/docs/data-apis/understand-data/new-relic-data-types/#events-new-relic) (for example, the `ComputeSample` event), and will be migrated to dimensional metrics in the future.

To assist in this transition, we provide a mechanism (known as shimming) that transparently lets you write queries in any format. Then these queries are processed as expected based on the source that's available (metrics or events). This mechanism works both ways, from events to metrics, and vice versa.

<Callout variant="tip">
  Learn more about [the limitations](/docs/query-your-data/nrql-new-relic-query-language/nrql-query-tutorials/query-infrastructure-dimensional-metrics-nrql/#known-limitations) of the query mechanism that allows customers to use event-based queries (samples) with the AWS CloudWatch Metric Stream integration (dimensional metric format).
</Callout>

Please consider the following when migrating from our poll-based integrations:

* <DNT>**Dashboards**</DNT>: Custom <InlinePopover type="dashboards"/> that use poll-based AWS integration events will still work as expected.
* <DNT>**Alerts**</DNT>: Alert conditions that use poll-based AWS events will still work. We recommend adapting those to the dimensional metric format (using NRQL as source).
* <DNT>**Entities**</DNT>: Your list of monitored entities might show duplicated entities for up to 24 hours.
* <DNT>**Attributes**</DNT>: Poll-based AWS integrations prefix collected resource tags with `label.`, while the AWS CloudWatch Metric Streams integration prefixes collected resource tags with `tags.`. If both integrations are enabled for the same AWS account, resource tags will appear under both prefixes when using the Event format.
