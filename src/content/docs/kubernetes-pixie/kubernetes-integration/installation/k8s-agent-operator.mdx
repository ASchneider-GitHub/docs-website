## Kubernetes Agent Operator

<Callout title="PUBLIC PREVIEW">
The K8s agent operator is in public preview.
</Callout>

The Kubernetes Agent Operator streamlines full-stack observability for Kubernetes environments by automating APM instrumentation alongside Kubernetes agent deployment. 
By enabling APM auto instrumentation, developers no longer need to manually manage APM Agents. The K8s agent operator will automatically install, upgrade and remove APM agents.

It currently supports Java, Ruby, Python, .NET, and Node.js, with additional languages (PHP and Go) coming soon.

## Getting Started

### Prerequisites

Before installing the operator, make sure you have:

- [Helm](https://helm.sh/) must be installed to use the charts. Please refer to Helm's [documentation](http://documentation) to get started.
- Kubectl configured to communicate with your cluster.
- Certificate manager installed in the cluster.


#### Installing the cert-manager dependency

To install the certificate manager dependency, run the following

    ```
    helm repo add jetstack https://charts.jetstack.io
    helm install cert-manager jetstack/cert-manager \
      --namespace cert-manager \
      --create-namespace \
      --set crds.enabled=true
    ```
    
### Installing the Kubernetes Agent Operator

Depending on your needs you can install the agent operator independently of our K8s integrations or together with it.
We strongly recommend to install it  together with the K8s integration to take advantage of our entire [Full Stack Obsevability](https://docs.newrelic.com/docs/apm/apm-ui-pages/monitoring/kubernetes-summary-page/) experience.

#### Bundle installation - alongside the K8s integration (recommended).

The K8s Agent operator chart is integrated as part of the [nri-bundle](https://github.com/newrelic/helm-charts/tree/master/charts/nri-bundle) chart, which manages the installation of all the components needed to enable a full K8s observability.
Add the `k8s-agent-operator.enabled=true` parameter to your helm command or include it in a [values.yaml](https://github.com/newrelic/helm-charts/blob/master/charts/nri-bundle/values.yaml) file.
Get more information about installing the K8s integrations using Helm on this [page](https://docs.newrelic.com/docs/kubernetes-pixie/kubernetes-integration/installation/kubernetes-integration-install-configure) or in the [chart](https://github.com/newrelic/helm-charts/tree/master/charts/nri-bundle) specification.

**Sample Helm command using parameters**

    ```
    helm repo add newrelic-k8s https://newrelic.github.io/k8s-agents-operator
    helm repo add newrelic https://helm-charts.newrelic.com

    KSM_IMAGE_VERSION="v2.10.0" && kubectl create namespace newrelic ; \
    helm upgrade --install newrelic-bundle ./charts/nri-bundle/ \
      --set global.licenseKey=<NEW RELIC INGEST LICENSE KEY> \
      --set global.cluster=<CLUSTER_NAME> \
      --namespace=newrelic \
      --set newrelic-infrastructure.privileged=true \
      --set global.lowDataMode=true \
      --set kube-state-metrics.image.tag=${KSM_IMAGE_VERSION} \
      --set kube-state-metrics.enabled=true \
      --set kubeEvents.enabled=true \
      --set k8s-agents-operator.enabled=true
    ```

#### Standalone installation

To install the Kubernetes Agent Operator with the default configuration, run the following commands:

**Sample command using a values.yaml file**

    helm repo add newrelic-k8s https://newrelic.github.io/k8s-agents-operator
    helm upgrade --install k8s-agents-operator k8s-agents-operator/k8s-agents-operator \
      --namespace k8s-agents-operator \
      --create-namespace \
      --values your-custom-values.yaml


For a complete list of configuration options, please refer to the [chart README](https://github.com/newrelic/k8s-agents-operator/tree/main/charts/k8s-agents-operator#values).

## Configuring the Operator

For each namespace you want the operator to be instrumented, create a secret containing a valid New Relic ingest license key:

    ```
    kubectl create secret generic newrelic-key-secret \
      --namespace my-monitored-namespace \
      --from-literal=new_relic_license_key=<NEW RELIC INGEST LICENSE KEY>
    ```

Make sure to replace `<NEW RELIC INGEST LICENSE KEY>` with your valid New Relic license key.

### Enable automatic APM instrumentation in applications

The k8s-agents-operator looks for language-specific annotations when your pods are being scheduled to know which applications you want to monitor.

Below are the currently supported annotations:

    ```
    instrumentation.newrelic.com/inject-java: "true"
    instrumentation.newrelic.com/inject-nodejs: "true"
    instrumentation.newrelic.com/inject-python: "true"
    instrumentation.newrelic.com/inject-dotnet: "true"
    instrumentation.newrelic.com/inject-ruby: "true"
    ```

Example deployment with annotation to instrument the Java agent:

    ```
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: spring-petclinic
    spec:
      selector:
        matchLabels:
          app: spring-petclinic
      replicas: 1
      template:
        metadata:
          labels:
            app: spring-petclinic
          annotations:
            instrumentation.newrelic.com/inject-java: "true"
        spec:
          containers:
            - name: spring-petclinic
              image: ghcr.io/pavolloffay/spring-petclinic:latest
              ports:
                - containerPort: 8080
              env:
              - name: NEW_RELIC_APP_NAME
                value: spring-petclinic-demo
    ```

### Upgrade APM instrumentation in applications

The K8s Agent operator automatically installs by default the latest versions of the corresponding APM agent available.
Once an applications is monitored it won’t automatically be upgraded to a newer version unless the customer decides to upgrade.
Application can seamlessly be upgraded to a newer version by simply redeploying the pods or restart your deployment.


### Remove APM instrumentation in applications

Simply remove the annotations used by the K8s agent operator, in a few seconds the APM Agents will be automatically removed.

### Upgrading the Operator

To upgrade to a newer version of the operator, use the `helm upgrade` command. For example:
    
    ```
    helm upgrade my-operator newrelic/k8s-agents-operator
    ```

## Uninstalling the Kubernetes Agent Operator

To uninstall/delete the operator, use the following command:

    ```
    helm delete my-operator
    ```

## Find and use data

- Get insights of your applications and resolve incidents using the [APM summary page](https://docs.newrelic.com/docs/apm/agents/manage-apm-agents/agent-data/triage-run-diagnostics/).
- The [Kubernetes summary page](https://docs.newrelic.com/docs/apm/apm-ui-pages/monitoring/kubernetes-summary-page/) provides you Kubernetes insights in the context of your monitored applications. 

## Frequently Asked Questions

### Can I route my applications telemetry to different accounts?**

Yes, you just need simply to modify the LICENSE KEY injected in the secret in the corresponding namespace.

<Callout title="PUBLIC PREVIEW">
The [K8s-APM experience](https://docs.newrelic.com/docs/apm/apm-ui-pages/monitoring/kubernetes-summary-page/) will only be available on the account where the data from applications and the K8s cluster is available.
</Callout>

### Can I setup the operator to inject an specific version of an APM agent?**

During the Preview we only support the latest version of any APM agent.
After GA we will enable users to modify the version of an APM agent.

### How can I modify the configuration of the APM agents?
<Pending>


## Troubleshooting

- My applications are not being instrumented, what do I need to check?
<Pending>

## Support

The K8s agent operator currently supports the latest version of the following APM agents:

- Python
- .NET
- Java
- Ruby
- NodeJS

Once the operator is on General Availability it will be supported the latest 3 versions of every APM agent.

If you encounter any problems with the Kubernetes Agent Operator, you can:
- Review the [issues section on GitHub](https://github.com/newrelic/k8s-agents-operator/issues) for any similar problems or consider opening a new issue.
- Reach out to [New Relic support](https://support.newrelic.com/).
