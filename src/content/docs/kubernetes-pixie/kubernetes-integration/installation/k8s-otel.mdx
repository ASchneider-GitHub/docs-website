---
title: 'OpenTelemetry for Kubernetes'
tags:
    - Kubernetes integration
    - OpenTelemetry
metaDescription: "Learn how to monitor your Kubernetes Cluster using OpenTelemetry"
freshnessValidatedDate: 2024-07-23
---


import k8sOTelDiagram from 'images/infrastructure_diagram_k8s-otel-stack.webp'


<Callout title="preview">
    We're still working on this feature, but we'd love for you to try it out!
    
    This feature is currently provided as part of a preview program pursuant to our [pre-release policies](/docs/licenses/license-information/referenced-policies/new-relic-pre-release-policy).
</Callout>


Kubernetes is an open-source tool for automating deployments, scaling, and managing containerized applications. The New Relic Kubernetes monitoring integration gives you a quick and easy way to see what's going on with your Kubernetes clusters and workloads, whether they're hosted on-premises or in the cloud.

This document outlines the process for monitoring a Kubernetes cluster using OpenTelemetry. It involves the installation of the [`nr-k8s-otel-collector`](https://github.com/newrelic/helm-charts/tree/master/charts/nr-k8s-otel-collector) Helm chart within the cluster and the deployment of the necessary collectors to enable first-class observability.

Once you've got the [Kubernetes integration up and running](/install/kubernetes/), you can start monitoring all the services running on Kubernetes in one place by [exploring your Kubernetes cluster](/docs/kubernetes-pixie/kubernetes-integration/understand-use-data/kubernetes-cluster-explorer/). It shows you everything from the top of the control plane down to the applications running on a single pod, so you can get to the heart of how your cluster works.

    <img
    title="K8s OpenTelemetry diagram"
    alt="K8s OpenTelemetry diagram"
    src={k8sOTelDiagram}
    />

By integrating Kubernetes components into the OpenTelemetry collector, we can send metrics, events, and logs directly to New Relic. These telemetry signals automatically enhance our out-of-the-box experiences such as the [Kubernetes navigator](/docs/kubernetes-pixie/kubernetes-integration/understand-use-data/kubernetes-cluster-explorer/#navigator-preview), [overview dashboard](/docs/kubernetes-pixie/kubernetes-integration/understand-use-data/kubernetes-cluster-explorer/#cluster-overview-dashboard), [Kubernetes events](/docs/kubernetes-pixie/kubernetes-integration/understand-use-data/kubernetes-cluster-explorer/#browse-your-kubernetes-events) or [Kubernetes APM summary page](/docs/apm/apm-ui-pages/monitoring/kubernetes-summary-page/). 


## How it works? [#how-works]

The [`nr-k8s-otel-collector`](https://github.com/newrelic/helm-charts/tree/master/charts/nr-k8s-otel-collector) Helm chart deploys these OpenTelemetry collectors:

- **Deamonset collector**: Deployed on each worker node and responsible for gathering metrics from the underlying host in the node, the `cAdvisor`, the  `Kubelet`, and collecting logs from the containers.

- **Deployment collector**: Deployed on the master node and responsible for gathering metrics of Kube state metrics and Kubernetes cluster events.


<Callout variant="tip">
    Although the `LowDataMode` option is enabled by default to ingest only the metrics required by our Kubernetes integration, you can also reduce the ingested data by changing the scrape interval value in the [`nr-k8s-otel-collector`](https://github.com/newrelic/helm-charts/tree/master/charts/nr-k8s-otel-collector) Helm chart. See [Reduce data ingested](/docs/kubernetes-pixie/kubernetes-integration/installation/reduce-ingest/) for more information on this.
</Callout>


## Requirements [#requirements]

To send Kubernetes telemetry data to New Relic, we need an OpenTelemetry collector. Our New Relic distribution of OpenTelemetry (NRDOT) is already set up to automatically monitor a Kubernetes cluster. It does this by deploying all the necessary components through our [`nr-k8s-otel-collector`](https://github.com/newrelic/helm-charts/tree/master/charts/nr-k8s-otel-collector) Helm chart.

If you switch to a different OpenTelemetry collector, make sure it has all the key components you need:

- [Attributes processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/attributesprocessor)
- [Filter processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/filterprocessor)
- [Filelog receiver](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/filelogreceiver)
- [GroupByAttrs processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/groupbyattrsprocessor)
- [Hostmetrics receiver](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/hostmetricsreceiver)
- [K8sAttributes processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/k8sattributesprocessor)
- [K8sevents receiver](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/k8seventsreceiver)
- [Kubelet receiver](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/kubeletstatsreceiver)
- [MetricsTransform processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/metricstransformprocessor)
- [Prometheus receiver](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/prometheusreceiver)
- [ResourceDetection processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor)
- [Resource processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourceprocessor)
- [Transform processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/transformprocessor)

## Install your Kubernetes cluster with OpenTelemetry [#install]

To get OpenTelemetry up and running in your cluster, follow these steps:

1. Download the [Helm chart values file](https://github.com/newrelic/helm-charts/tree/master/charts/nr-k8s-otel-collector/values.yaml#L20-L24) adapt it to meet your specific requirements.

    * Cluster name and <InlinePopover type="licenseKey" /> are mandatory.

    * Check the entire list of [configuration parameters](https://github.com/newrelic/helm-charts/tree/master/charts/nr-k8s-otel-collector#values).

2. Install the [Helm chart](https://github.com/newrelic/helm-charts/tree/master/charts/nr-k8s-otel-collector) together with the values file.

    ```shell
    helm repo add newrelic https://helm-charts.newrelic.com
    helm upgrade nr-k8s-otel-collector newrelic/nr-k8s-otel-collector -f your-custom-values.yaml -n newrelic --create-namespace --install
    ```

3. Ensure the pods have been successfully spun up.

    ```shell
        kubectl get pods -n newrelic --watch
    ````

4. Make sure New Relic is getting the data it needs, including metrics, events, and logs, by running the right queries. See [Introduction to the query builder](/docs/query-your-data/explore-query-data/query-builder/introduction-query-builder/) for more information.

    ```sql
    FROM Metric SELECT * WHERE k8s.cluster.name='<CLUSTER_NAME>'
    FROM InfrastructureEvent SELECT * WHERE k8s.cluster.name='<CLUSTER_NAME>'
    FROM Log SELECT * WHERE k8s.cluster.name='<CLUSTER_NAME>'
    ```

5. If you're using a GKE AutoPilot cluster, it's necessary to apply the following configuration in your `values.yaml` file to ensure compatibility and proper functionality of the OpenTelemetry collectors.

    ```yaml
    privileged: false
    receivers:
        filelog:
            enabled: false
    daemonset:
        containerSecurityContext:
            privileged: false
    ```

## Uninstall your Kubernetes cluster with OpenTelemetry [#uninstall]

To stop monitoring a Kubernetes cluster with OpenTelemetry, run this command:

```shell
    helm uninstall nr-k8s-otel-collector -n newrelic
```

## Find and use data [#find]

Check out these documents to learn more on how to find data:

- [Explore your Kubernetes cluster](/docs/kubernetes-pixie/kubernetes-integration/understand-use-data/kubernetes-cluster-explorer/) to know the status of your cluster, from the control plane to nodes and pods.

- [Kubernetes APM summary page](/docs/apm/apm-ui-pages/monitoring/kubernetes-summary-page/) which offers insights into your Kubernetes integration alongside your monitored applications.

## Troubleshooting [#troubleshooting]

Check out the logs of the collector pod that's experiencing issues. Run this command:

```shell
    kubectl logs <otel-pod-name> -n newrelic
```

You can also set the `verboseLog` parameter to `true` in the [`nr-k8s-otel-collector`](https://github.com/newrelic/helm-charts/tree/master/charts/nr-k8s-otel-collector#values) Helm chart.


## Common errors [#common-erros]

You can get these common errors:

<CollapserGroup>
    <Collapser
        id="exporting-errors"
        title="Exporting errors"
    >
    
    Timeout errors during collector startup are expected as the collector attempts to connect to NR. These timeout errors may also occur over time while the collector is running, but are transient and expected to resolve themselves. These errors are similar to this one:
    
    ```shell
        info	exporterhelper/retry_sender.go:154	Exporting failed. Will retry the request after interval.	{"kind": "exporter", "data_type": "metrics", "name": "otlphttp/newrelic", "error": "failed to make an HTTP request: Post \"https://staging-otlp.nr-data.net/v1/metrics\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)", "interval": "5.445779213s"}
    ```

    </Collapser>
    <Collapser
        id="no-file-directory"
        title="No such file or directory"
    >

    Sometimes, you'll see failed to open file errors on the filelog and hostmetrics receiver because of a race condition where the file or directory no longer exists. This can be because the pod or process was short-lived (like a cronjob or sleep) and the pod or process was terminated before the collector could read the file.

    Example of `filelog` error:

    ```shell
        Failed to open file	{"kind": "receiver", "name": "filelog", "data_type": "logs", "component": "fileconsumer", "error": "open /var/log/pods/<podname>/<containername>/0.log: no such file or directory"}
    ```

    Example of `hostmetrics` error:

    ```shell
        Error scraping metrics	{"kind": "receiver", "name": "hostmetrics", "data_type": "metrics", "error": "error reading <metric> for process \"<process>\" (pid <PID>): open /hostfs/proc/<PID>/stat: no such file or directory; error reading <metric> info for process \"<process>\" (pid 511766): open /hostfs/proc/<PID>/<metric>: no such file or directory", "scraper": "process"}
    ```

    </Collapser>
</CollapserGroup>


## Support [#support]

If you have issues with the OpenTelemetry observability for Kubernetes:

- Have a look at the [issues section on GitHub](https://github.com/newrelic/helm-charts/issues) for any similar problems or consider opening a new issue.

-  Reach out to the [New Relic support](https://support.newrelic.com/s/) for assistance.

