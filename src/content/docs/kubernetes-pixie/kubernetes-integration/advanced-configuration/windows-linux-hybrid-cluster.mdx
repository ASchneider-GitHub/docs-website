# Kubernetes Integration on Hybrid cluster with Windows and Linux nodes

The purpose of this document is to clarify the available options for installing the Kubernetes integration to a mixed Windows/Linux cluster.

## Prerequisites

A cluster with Windows and Linux nodes, including the ability to pull container images to the Windows nodes.

Set up the Helm repo and create a namespace:

```
helm repo add newrelic https://helm-charts.newrelic.com
helm repo update
kubectl create namespace newrelic
```

## Install the current chart bundle

This is the regular newrelic/nri-bundle chart with all the latest updates for everything on Linux nodes. Exception is that the newrelic-logging chart can be configured to install to Windows. This is a supported, stable feature of ONLY the logging chart currently.

Other charts currently require a NodeSelector to be configured, to avoid scheduling to Windows. If an installation is failing on a mixed cluster, while using default values from guided install, the solution is to add the `nodeSelector` values.

Create the values file with your favorite text editor, let's call it `values.yaml`:

Please note that you can download a starter `values.yaml` file from the New Relic UI, by adding the Kubernetes integration and select the instrumentation method as "Helm".

```
global:
  licenseKey: mykey
  cluster: mycluster
  lowDataMode: true
 
newrelic-infrastructure:
  enabled: true
  nodeSelector:
    kubernetes.io/os: linux
 
kube-state-metrics:
  enabled: true
  image:
    tag: v2.10.0
  nodeSelector:
    kubernetes.io/os: linux
 
nri-kube-events:
  enabled: true
  nodeSelector:
    kubernetes.io/os: linux
 
newrelic-logging:
  enabled: true
  enableWindows: true
 
nri-metadata-injection:
  enabled: true
  nodeSelector:
    kubernetes.io/os: linux
 
newrelic-prometheus-agent:
  enabled: true
  verboseLog: true
  config:
    kubernetes:
      integrations_filter:
        enabled: false
  nodeSelector:
    kubernetes.io/os: linux
```

## Install the bundle

```
helm upgrade --install newrelic-bundle newrelic/nri-bundle --namespace newrelic -f values-newrelic.yaml

```

After Helm returns, you should see all pods successfully started, including a logging pod on each Windows node (but no other New Relic pods on Windows nodes yet).

## Installing newrelic-infrastructure preview for Windows nodes

The example below is for a cluster with Windows 2022 nodegroup/node pool. Adjust the `windowsOsList` section with the appropriate values from our [docs](https://docs.newrelic.com/docs/kubernetes-pixie/kubernetes-integration/installation/kubernetes-integration-install-configure/#windows-install) if running 2019 or 20h2.

Create the values file for the `newrelic-infrastructure` v2 chart, for example `windows-values.yaml`:

```
global:
  licenseKey: mykey
  cluster: mycluster
 
enableLinux: false
enableWindows: true
windowsOsList:
  - version: 2022
    imageTag: 2-windows-ltsc2022-alpha
    buildNumber: 10.0.20348
windowsNodeSelector:
  kubernetes.io/os: windows
```

Install the v2.7.2 release of the newrelic-infrastructure chart, per our official preview docs:

```
helm upgrade --install newrelic-windows newrelic/newrelic-infrastructure --namespace newrelic --version 2.7.2 -f windows-values.yaml
```

After Helm returns, you should see `newrelic-windows-newrelic-infrastructure` pods on each Windows node.

## Expected results

Windows nodes appear in the Kubernetes cluster UI in New Relic, along with their infrastructure metrics, running pods, etc.

