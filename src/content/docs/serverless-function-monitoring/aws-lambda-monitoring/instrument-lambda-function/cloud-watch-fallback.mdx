---
title: "CloudWatch fallback"
metaDescription: This doc guides you through shipping your telemetry data with Cloudwatch as a fail-safe option.
freshnessValidatedDate: never
---

You can ship New Relic Lambda monitoring data in a few different ways depending on your needs. The option that provides the strongest performance of your function and the strongest fail-safe is the CloudWatch fallback option. This means that you will ship telemetry to New Relic through the agent and use the extension to enhance the telemetry collection but, if there's a problem with the extension, you will still receive logs and payloads in CloudWatch.  

While this offers the strongest fail-safe, it's important to note that the AWS CloudWatch service can generate a lot of data. Keep data ingest in mind when thinking about costs and which New Relic pricing plan you choose. 

Benefits of the CloudWatch fallback:

* Captures all logs from CloudWatch independently of your function's execution. There's less chance it will interfere with the normal operation, or impact the invocation duration of your function.
* Useful for functions in a VPC that can't have outbound traffic to New Relic.
* CloudWatch is need for other forms of infra and database telemetry. To learn more, see our [Amazon RDS Enhanced Monitoring integration docmentation](/docs/infrastructure/amazon-integrations/aws-integrations-list/aws-rds-enhanced-monitoring-integration/).

## CloudWatch fallback [#fallback]

Even with those best practices in place, having a fallback can always be a good plan of action. There are three ways you can implement a CloudWatch fallback:

    1. **Enable the extension enabled for payloads and disable the extension for logs**: In this scenario, if the extension fails, payloads will be sent through CloudWatch but CloudWatch will always send logs. 
    2. **Extension enabled for payloads and logs**: In this scenario, if the extension fails, CloudWatch will send payloads. 
    3. **Extension disabled**: In this scenario, CloudWatch is always used to send logs and payloads.

## Before you begin  [#requirements]

Before you set up a fallback option you will need to complete the following:

    * Install your function from the AWS region where you want to send logs from.
    * If sending logs, create a  filter pattern equal to null, or a custom pattern to match the function logs you want to send. CloudWatch logs for your function will be sent to New Relic. To avoid duplicate logs, the extension needs to have its log shipping disabled. The extension is disabled by default.

## Payload fallback with optional CloudWatch logs [#one]

If you aren't sending logs to CloudWatch, this option is the lowest cost and offers the most robust way to ensure instrumented payloads always make it to New Relic. If you are sending logs, this option will introduce some CloudWatch costs for log shipment.


### Configuration [#configuration-one]

After adding a New Relic Lambda layer, the Extension will be enabled and have log shipping disabled by default.

Set [extension environment variables ](https://github.com/newrelic/newrelic-lambda-extension/blob/main/config/config.go)set on your function:
    * NEW_RELIC_LAMBDA_EXTENSION_ENABLED: true (default)
    * NEW_RELIC_EXTENSION_SEND_FUNCTION_LOGS: false (default)

Set your `aws-log-ingestion` function environment variables:
    * INFRA_ENABLED: true
    * LOGGING_ENABLED: true (if sending logs)

If you're using [serverless-newrelic-lambda-layers](https://github.com/newrelic/serverless-newrelic-lambda-layers), set:

```
custom:
    newRelic:
        enableExtension: true
        enableFunctionLogs: false
        enableIntegration: true
        cloudWatchFilter: "*"
```

If you're using the [newrelic-lambda-cli](https://github.com/newrelic/newrelic-lambda-cli), set:
    * newrelic-lambda integrations install --nr-account-id &lt;account id> --nr-api-key &lt;api key> --enable-logs
    * newrelic-lambda layers install --function &lt;name or arn> --nr-account-id &lt;new relic account id>
    * newrelic-lambda subscriptions install --function &lt;name or arn> --filter-pattern ""


## Payload fallback with optional extension logs [#two]

This option is the lowest cost way to ensure instrumented payloads always make it to New Relic. This option ships function logs through the New Relic Lambda extension, so if the extension fails to start up or crashes, function logs will be missing from New Relic.

If you're sending function logs, make sure the extension is configured to do so. These logs will only be sent by the extension and there will not be a CloudWatch fallback for logs in order to avoid duplicates.

### Configuration [#configuration-2]

After adding a New Relic Lambda layer, the Extension will be enabled and have log shipping disabled by default. If you want to see function logs in New Relic, you’ll need to enable Extension sending of function logs with an environment variable.

It’s important to note that function logs are just that, logs that are recorded by the function during its invocation. The Extension will not send Lambda runtime logs like START, END, and REPORT lines._

Set [extension environment](https://github.com/newrelic/newrelic-lambda-extension/blob/main/config/config.go) variables set on your function:
    * NEW_RELIC_LAMBDA_EXTENSION_ENABLED: true (default)
    * NEW_RELIC_EXTENSION_SEND_FUNCTION_LOGS: true

Set your `aws-log-ingestion` function environment variables:
* INFRA_ENABLED: true
* LOGGING_ENABLED: false (disable log forwarding to avoid duplicates or set the CloudWatch subscription filter pattern to match NR_LAMBDA_MONITORING lines only)

If you're using [serverless-newrelic-lambda-layers](https://github.com/newrelic/serverless-newrelic-lambda-layers), set:

```
custom:
    newRelic:
        enableExtension: true
        enableFunctionLogs: true
        enableIntegration: true
        cloudWatchFilter: "NR_LAMBDA_MONITORING" (only send payloads)
```

If you're using the [newrelic-lambda-cli](https://github.com/newrelic/newrelic-lambda-cli), set: 
    * newrelic-lambda integrations install --nr-account-id &lt;account id> --nr-api-key &lt;api key>
    * newrelic-lambda layers install --function &lt;name or arn> --nr-account-id &lt;new relic account id>
    * newrelic-lambda subscriptions install --function &lt;name or arn> --filter-pattern "NR_LAMBDA_MONITORING"


## Always send logs and payloads via CloudWatch [#three]

This option relies completely on CloudWatch and our `aws-log-ingestion` function to ship logs and payloads to New Relic. This option has the extension disabled to avoid potential downtime caused by extension failures.

For this method, the New Relic Lambda extension needs to be disabled completely to avoid encoding the NR_LAMBDA_MONITORING line. With the New Relic Lambda extension disabled, all telemetry will go out via CloudWatch + subscription filter + aws-log-ingestion function.

### Configuration [#configuration-3]

After adding a New Relic Lambda layer, the Extension will be enabled and have log shipping disabled by default. You'll need to disable the Extension with an environment variable.

Set[extension environment variables ](https://github.com/newrelic/newrelic-lambda-extension/blob/main/config/config.go) set on your function:
    * NEW_RELIC_LAMBDA_EXTENSION_ENABLED: false

Set your `aws-log-ingestion` function environment variables:
    * INFRA_ENABLED: true
    * LOGGING_ENABLED: true

If you're using [serverless-newrelic-lambda-layers](https://github.com/newrelic/serverless-newrelic-lambda-layers), set:

custom:
newRelic:
    enableExtension: false
    enableIntegration: true
    cloudWatchFilter: "*”

If you're using the [newrelic-lambda-cli](https://github.com/newrelic/newrelic-lambda-cli), set: 
    * newrelic-lambda integrations install --nr-account-id &lt;account id> --nr-api-key &lt;api key>
    * newrelic-lambda layers install --function &lt;name or arn> --nr-account-id &lt;new relic account id> --disable-extension
    * newrelic-lambda subscriptions install --function &lt;name or arn> --filter-pattern ""

