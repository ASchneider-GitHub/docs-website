---
title: CloudWatch fallback
metaDescription: How to update New Relic's AWS Lambda monitoring.
redirects:
  - /docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/update-lambda-monitoring
  - /docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/update-serverless-monitoring-aws-lambda
freshnessValidatedDate: never
---

By adding a log subscription filter to pipe your function logs into the Lambda function, we can recover that CloudWatch log line and forward it on to New Relic, along with some other platform telemetry.

However, this approach has some considerable drawbacks. The AWS CloudWatch service can generate a lot of data. If you're on our Free edition, you may hit your data limit pretty quickly. If you're paying for data, you may find this service making up the largest share of the data you're sending to New Relic.

There are also some advantages to the CloudWatch path:

    * Captures all logs from CloudWatch independently of your function's execution. There's less chance it will interfere with the normal operation or impact the invocation duration of your function.
    * Useful for functions in a VPC that can't have outbound traffic to New Relic.
    * Needed for other forms of infra/database telemetry.

## CloudWatch fallback [#fallback]

Why is a CloudWatch fallback worth considering? While the  can decrease latency and costs compared to shipping logs and payloads via CloudWatch and the  function, the Extension can also introduce some challenges.

If the Extension fails to start up, it will not send telemetry to New Relic. The Extension will impact invocation durations somewhat and has the potential to lead to invocation timeouts or failures, especially when updating to the latest layer. Prior to updating to a newer layer version, consider the following:

    * The latest layer might introduce breaking changes in the extension or a third-party dependency.
    * It's a good idea to pin a layer version that is known to work well for your function and only update it as needed to resolve bugs, obtain new features/security patches, or before an agent EOL.
    * Carefully review all changes and release notes and test in a lower environment (dev, staging) before deploying a new layer to production.

Even with those best practices in place, having a fallback should things go awry can still be desirable. There are a couple of ways to utilize the  function to make sending logs and payloads to New Relic more reliable versus the Extension alone:

    1. Extension enabled for payloads, Extension log sending disabled (Cloudwatch fallback for payloads if the Extension fails, CloudWatch always sends logs)
    2. Extension enabled for payloads and logs (CloudWatch fallback for payloads if the Extension fails)
    3. Extension disabled (CloudWatch always for logs and payloads)

When the Extension is enabled and running, it will look for a payload generated by the New Relic agent called NR_LAMBDA_MONITORING. If found, the Extension will encode this payload and ship it to New Relic directly (bypassing CloudWatch). With Extension debug logging enabled, you will see a log line called "Agent telemetry bytes" which contains the base64, gzipped payload.

If something goes wrong with the Extension, the NR_LAMBDA_MONITORING payload will not be encoded or shipped, and telemetry will be missing from New Relic. As a result, the NR_LAMBDA_MONITORING payload will get written to CloudWatch.

When the  function is configured with an environment variable INFRA_ENABLED: true, it looks for the NR_LAMBDA_MONITORING payload and ships it to New Relic. This method can be used as a fallback for shipping payloads if the Extension fails.Fallback Method 1 (payload fallback with optional CloudWatch logs)

If not sending logs, option 1 is the lowest cost, most robust way to ensure instrumented payloads always make it to New Relic. If sending logs, option 1 will introduce some CloudWatch costs for log shipment.

## Requirements [#requirements]

    * The  function needs to be installed per AWS region where you want to send logs from.
    * If sending logs, create a  filter pattern equal to null (empty) or a custom pattern to match the function logs you want to send. CloudWatch logs for your function will be sent to New Relic. To avoid duplicate logs, the Extension needs to have its log shipping disabled (which is the default).

If the Extension fails to start up (noop mode) or crashes, it will fail to encode the NR_LAMBDA_MONITORING line, thus the NR_LAMBDA_MONITORING line will appear in CloudWatch logs. In this scenario, you will still get telemetry via the CloudWatch payload fallback and function logs via CloudWatch + subscription filter +  function. Nothing will be missing in New Relic.

After adding a New Relic Lambda layer, the Extension will be enabled and have log shipping disabled by default


## Payload fallback with optional CloudWatch logs [#one]

If not sending logs, option 1 is the lowest cost, most robust way to ensure instrumented payloads always make it to New Relic. If sending logs, option 1 will introduce some CloudWatch costs for log shipment.

### Requirements [#requirements-one]

    * The aws-log-ingestion function needs to be installed per AWS region where you want to send logs from.
    * If sending logs, create a [`<code>[CloudWatch subscription](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Subscriptions.html)</code>`](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Subscriptions.html) filter pattern equal to null (empty) or a custom pattern to match the function logs you want to send. CloudWatch logs for your function will be sent to New Relic. To avoid duplicate logs, the Extension needs to have its log shipping disabled (which is the default).

If the Extension fails to start up (noop mode) or crashes, it will fail to encode the NR_LAMBDA_MONITORING line, thus the NR_LAMBDA_MONITORING line will appear in CloudWatch logs. In this scenario you will still get telemetry via the CloudWatch payload fallback, and you will already be getting function logs via CloudWatch + subscription filter + aws-log-ingestion function. Nothing will be missing in New Relic.

### Configuration [#configuration-one]

After adding a New Relic Lambda layer, the Extension will be enabled and have log shipping disabled by default.

Extension environment variables (set on your function):

* NEW_RELIC_LAMBDA_EXTENSION_ENABLED: true (default)
* NEW_RELIC_EXTENSION_SEND_FUNCTION_LOGS: false (default)

aws-log-ingestion function environment variables:

* INFRA_ENABLED: true
* LOGGING_ENABLED: true (if sending logs)

[serverless-newrelic-lambda-layers](https://github.com/newrelic/serverless-newrelic-lambda-layers):

custom:

  newRelic:
enableExtension: true
enableFunctionLogs: false
enableIntegration: true
cloudWatchFilter: "*"

[newrelic-lambda-cli](https://github.com/newrelic/newrelic-lambda-cli):

* newrelic-lambda integrations install --nr-account-id &lt;account id> --nr-api-key &lt;api key> --enable-logs
* newrelic-lambda layers install --function &lt;name or arn> --nr-account-id &lt;new relic account id>
* newrelic-lambda subscriptions install --function &lt;name or arn> --filter-pattern ""


## Payload fallback with optional extension logs [#two]

Even with log shipment, option 2 is the lowest cost way to ensure instrumented payloads always make it to New Relic. This option ships function logs via the Extension, so if the Extension fails to start up or crashes, function logs will be missing from New Relic.


### Requirements [#requirements-two]

* The [aws-log-ingestion](https://github.com/newrelic/aws-log-ingestion) function [needs to be installed](https://docs.newrelic.com/docs/logs/forward-logs/aws-lambda-sending-cloudwatch-logs/) per AWS region where you want to send logs from.
* If sending function logs, ensure the Extension is configured to do so. These logs will only be sent by the Extension and there will not be a CloudWatch fallback for logs in order to avoid duplicates.

If the Extension fails to start up (noop mode) or crashes, it will fail to encode the NR_LAMBDA_MONITORING line, thus the NR_LAMBDA_MONITORING line will appear in CloudWatch logs. In this scenario you will still get telemetry via the CloudWatch payload fallback. Only function logs will be missing in New Relic.


### Configuration [#configuration-2]

After adding a New Relic Lambda layer, the Extension will be enabled and have log shipping disabled by default. If you want to see function logs in New Relic, you’ll need to enable Extension sending of function logs with an environment variable.

It’s important to note that function logs are just that, logs that are recorded by the function during its invocation. The Extension will not send Lambda runtime logs like START, END, and REPORT lines._

Extension [environment variables](https://github.com/newrelic/newrelic-lambda-extension/blob/main/config/config.go) (set on your function):


* NEW_RELIC_LAMBDA_EXTENSION_ENABLED: true (default)
* NEW_RELIC_EXTENSION_SEND_FUNCTION_LOGS: true

aws-log-ingestion function environment variables:

* INFRA_ENABLED: true
* LOGGING_ENABLED: false (disable log forwarding to avoid duplicates or set the CloudWatch subscription filter pattern to match NR_LAMBDA_MONITORING lines only)

[serverless-newrelic-lambda-layers](https://github.com/newrelic/serverless-newrelic-lambda-layers):

custom:

  newRelic:

    enableExtension: true

    enableFunctionLogs: true

    enableIntegration: true

    cloudWatchFilter: "NR_LAMBDA_MONITORING" (only send payloads)

[newrelic-lambda-cli](https://github.com/newrelic/newrelic-lambda-cli):



* newrelic-lambda integrations install --nr-account-id &lt;account id> --nr-api-key &lt;api key>
* newrelic-lambda layers install --function &lt;name or arn> --nr-account-id &lt;new relic account id>
* newrelic-lambda subscriptions install --function &lt;name or arn> --filter-pattern "NR_LAMBDA_MONITORING"


## Always send logs and payloads via CloudWatch [#three]

Option 3 relies completely on CloudWatch and our aws-log-ingestion function to ship logs and payloads to New Relic. This option has the Extension disabled to avoid potential downtime caused by Extension failures.


### Requirements [#requirements-three]


* The [aws-log-ingestion](https://github.com/newrelic/aws-log-ingestion) function [needs to be installed](https://docs.newrelic.com/docs/logs/forward-logs/aws-lambda-sending-cloudwatch-logs/) per AWS region where you want to send logs from.
* If sending logs, create a [CloudWatch subscription](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Subscriptions.html) filter pattern equal to null (empty) or a custom pattern to match the function logs you want to send. CloudWatch logs and payloads for your function will be sent to New Relic. The Extension needs to be disabled completely to avoid encoding the NR_LAMBDA_MONITORING line.

With the Extension disabled, all telemetry will go out via CloudWatch + subscription filter + aws-log-ingestion function.


### Configuration [#configuration-3]

After adding a New Relic Lambda layer, the Extension will be enabled and have log shipping disabled by default. You’ll need to disable the Extension with an environment variable.

Extension [environment variables](https://github.com/newrelic/newrelic-lambda-extension/blob/main/config/config.go) (set on your function):



* NEW_RELIC_LAMBDA_EXTENSION_ENABLED: false

aws-log-ingestion function environment variables:

* INFRA_ENABLED: true
* LOGGING_ENABLED: true

[serverless-newrelic-lambda-layers](https://github.com/newrelic/serverless-newrelic-lambda-layers):

custom:
newRelic:
    enableExtension: false
    enableIntegration: true
    cloudWatchFilter: "*”

[newrelic-lambda-cli](https://github.com/newrelic/newrelic-lambda-cli):


* newrelic-lambda integrations install --nr-account-id &lt;account id> --nr-api-key &lt;api key>
* newrelic-lambda layers install --function &lt;name or arn> --nr-account-id &lt;new relic account id> --disable-extension
* newrelic-lambda subscriptions install --function &lt;name or arn> --filter-pattern ""

